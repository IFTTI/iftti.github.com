---
layout: post
title: '从 Linux 源码看 socket 的阻塞和非阻塞'
time: 2018-04-12 00:00:00 +0800
site_name: jobbole.com
source_url: http://blog.jobbole.com/113858/
images:
  bb9b6d65074a390c3e3eb70f3eeba2d8: http://wx2.sinaimg.cn/mw690/63918611gy1fq9n10wguaj20vi0katb1.jpg
  ac41a3384718e059358995db765643c2: http://wx3.sinaimg.cn/mw690/63918611gy1fq9n11nhljj20ui0eadi7.jpg
  e5e99f4d674862051cc71c6cc4dceea5: http://wx1.sinaimg.cn/mw690/63918611gy1fq9n12m0pcj20wg0eetbd.jpg
  4154689d84c9813900d6221a9b5f84d4: http://wx1.sinaimg.cn/mw690/63918611gy1fq9n13is3fj20ws0j4go5.jpg
  922d2133d26b7e8cd28adbb0c85b5c2c: http://wx3.sinaimg.cn/mw690/63918611gy1fq9n14e3v5j212g09wdh9.jpg
  0f4390b61a016f52b8135529f2496336: http://wx1.sinaimg.cn/mw690/63918611gy1fq9n15gvtaj20z60k8acz.jpg
  a46f78d6f0ca9d1a9f9fb8cdf1d9a2e3: http://wx3.sinaimg.cn/mw690/63918611gy1fq9n16qg5xj21540rw43a.jpg
  1878d8b3db0d5e69c600c15a0d220522: http://wx4.sinaimg.cn/mw690/63918611gy1fq9n17pdxbj213s0oc0vh.jpg
  cde7a651a7abd5209bb2139b78b579ce: http://wx2.sinaimg.cn/mw690/63918611gy1fq9n18hqx2j20zq0kigng.jpg
---
{% raw %}


        			<div class="textwidget"></div>
		
		<p>笔者一直觉得如果能知道从应用到框架再到操作系统的每一处代码，是一件Exciting的事情。</p>
<p>大部分高性能网络框架采用的是非阻塞模式。笔者这次就从linux源码的角度来阐述socket阻塞(block)和非阻塞(non_block)的区别。 本文源码均来自采用Linux-2.6.24内核版本。</p>
<h2 id="h2_1">一个TCP非阻塞client端简单的例子</h2>
<p>如果我们要产生一个非阻塞的socket,在C语言中如下代码所示:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f044933701662" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
// 创建socket
int sock_fd = socket(AF_INET, SOCK_STREAM, 0);
...
// 更改socket为nonblock
fcntl(sock_fd, F_SETFL, fdflags | O_NONBLOCK);
// connect
....
while(1)  {  
    int recvlen = recv(sock_fd, recvbuf, RECV_BUF_SIZE) ; 
    ......
} 
...</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f044933701662-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f044933701662-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f044933701662-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f044933701662-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f044933701662-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f044933701662-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f044933701662-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f044933701662-8">8</div>
<div class="crayon-num" data-line="crayon-5ad811534f044933701662-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f044933701662-10">10</div>
<div class="crayon-num" data-line="crayon-5ad811534f044933701662-11">11</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f044933701662-12">12</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f044933701662-1"><span class="crayon-c">// 创建socket</span></div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f044933701662-2">
<span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">sock_fd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">socket</span><span class="crayon-sy">(</span><span class="crayon-v">AF_INET</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SOCK_STREAM</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f044933701662-3">
<span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f044933701662-4"><span class="crayon-c">// 更改socket为nonblock</span></div>
<div class="crayon-line" id="crayon-5ad811534f044933701662-5">
<span class="crayon-e">fcntl</span><span class="crayon-sy">(</span><span class="crayon-v">sock_fd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">F_SETFL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">fdflags</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">O_NONBLOCK</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f044933701662-6"><span class="crayon-c">// connect</span></div>
<div class="crayon-line" id="crayon-5ad811534f044933701662-7">
<span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f044933701662-8">
<span class="crayon-st">while</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h">  </span><span class="crayon-sy">{</span><span class="crayon-h">  </span>
</div>
<div class="crayon-line" id="crayon-5ad811534f044933701662-9">
<span class="crayon-h">    </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">recvlen</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">recv</span><span class="crayon-sy">(</span><span class="crayon-v">sock_fd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">recvbuf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">RECV_BUF_SIZE</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">;</span><span class="crayon-h"> </span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f044933701662-10">
<span class="crayon-h">    </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f044933701662-11">
<span class="crayon-sy">}</span><span class="crayon-h"> </span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f044933701662-12">
<span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->
<p>由于网络协议非常复杂，内核里面用到了大量的面向对象的技巧，所以我们从创建连接开始，一步一步追述到最后代码的调用点。</p>
<h3 id="h3_2">socket的创建</h3>
<p>很明显，内核的第一步应该是通过AF_INET、SOCK_STREAM以及最后一个参数0定位到需要创建一个TCP的socket,如下图绿线所示:</p>
<p><img src="/images/jobbole.com/bb9b6d65074a390c3e3eb70f3eeba2d8.jpg"></p>
<p>我们跟踪源码调用</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f04e419379131" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
socket(AF_INET, SOCK_STREAM, 0)
	|-&gt;sys_socket 进入系统调用
		|-&gt;sock_create
			|-&gt;__sock_create</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f04e419379131-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f04e419379131-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f04e419379131-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f04e419379131-4">4</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f04e419379131-1">
<span class="crayon-e">socket</span><span class="crayon-sy">(</span><span class="crayon-v">AF_INET</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SOCK_STREAM</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f04e419379131-2">
<span class="crayon-h">	</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sys</span><span class="crayon-sy">_</span>socket<span class="crayon-h"> </span>进入系统调用</div>
<div class="crayon-line" id="crayon-5ad811534f04e419379131-3">
<span class="crayon-h">		</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sock_create</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f04e419379131-4">
<span class="crayon-h">			</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">__sock_create</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>进一步分析__sock_create的代码判断:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f052166626982" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
const struct net_proto_family *pf;
// RCU(Read-Copy Update)是linux的一种内核同步方法，在此不阐述
// family=INET
pf = rcu_dereference(net_families[family]);
err = pf-&gt;create(net, sock, protocol);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f052166626982-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f052166626982-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f052166626982-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f052166626982-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f052166626982-5">5</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f052166626982-1">
<span class="crayon-r">const</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">net_proto_family</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">pf</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f052166626982-2"><span class="crayon-c">// RCU(Read-Copy Update)是linux的一种内核同步方法，在此不阐述</span></div>
<div class="crayon-line" id="crayon-5ad811534f052166626982-3"><span class="crayon-c">// family=INET</span></div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f052166626982-4">
<span class="crayon-v">pf</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">rcu_dereference</span><span class="crayon-sy">(</span><span class="crayon-v">net_families</span><span class="crayon-sy">[</span><span class="crayon-v">family</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f052166626982-5">
<span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pf</span><span class="crayon-o">-&gt;</span><span class="crayon-e">create</span><span class="crayon-sy">(</span><span class="crayon-v">net</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">protocol</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->
<p><span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span> <span class="hljs-title"><span class="hljs-class"><span class="hljs-title">net_proto_family</span></span></span></span> *pf; <span class="hljs-comment"><span class="hljs-comment">// RCU(Read-Copy Update)是linux的一种内核同步方法，在此不阐述</span></span> <span class="hljs-comment"><span class="hljs-comment">// family=INET</span></span> pf = rcu_dereference(net_families[family]); err = pf-&gt;create(net, sock, protocol);</p>
<p><img src="/images/jobbole.com/ac41a3384718e059358995db765643c2.jpg"></p>
<p>则通过源码可知，由于是AF_INET(PF_INET),所以net_families[PF_INET].create=inet_create(以后我们都用PF_INET表示)，即<br>
pf-&gt;create = inet_create; 进一步追溯调用:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f057911869488" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
inet_create(struct net *net, struct socket *sock, int protocol){
	Sock* sock;
	......
	// 此处是寻找对应协议处理器的过程
lookup_protocol:
	// 迭代寻找protocol==answer-&gt;protocol的情况
	list_for_each_rcu(p, &amp;inetsw[sock-&gt;type]) answer = list_entry(p, struct inet_protosw, list);

		/* Check the non-wild match. */
		if (protocol == answer-&gt;protocol) {
			if (protocol != IPPROTO_IP)
				break;
		}
	......
	// 这边answer指的是SOCK_STREAM
	sock-&gt;ops = answer-&gt;ops;
	answer_no_check = answer-&gt;no_check;
	// 这边sk-&gt;prot就是answer_prot=&gt;tcp_prot
	sk = sk_alloc(net, PF_INET, GFP_KERNEL, answer_prot);
	sock_init_data(sock, sk);
	......
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-8">8</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-10">10</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-11">11</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-12">12</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-13">13</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-14">14</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-15">15</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-16">16</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-17">17</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-18">18</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-19">19</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-20">20</div>
<div class="crayon-num" data-line="crayon-5ad811534f057911869488-21">21</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f057911869488-22">22</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f057911869488-1">
<span class="crayon-e">inet_create</span><span class="crayon-sy">(</span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">net</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">net</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">socket</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">sock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">protocol</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-2">
<span class="crayon-h">	</span><span class="crayon-v">Sock</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">sock</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-3">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-4">
<span class="crayon-h">	</span><span class="crayon-c">// 此处是寻找对应协议处理器的过程</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-5">
<span class="crayon-v">lookup_protocol</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-6">
<span class="crayon-h">	</span><span class="crayon-c">// 迭代寻找protocol==answer-&gt;protocol的情况</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-7">
<span class="crayon-h">	</span><span class="crayon-e">list_for_each_rcu</span><span class="crayon-sy">(</span><span class="crayon-v">p</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">inetsw</span><span class="crayon-sy">[</span><span class="crayon-v">sock</span><span class="crayon-o">-&gt;</span><span class="crayon-v">type</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">answer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list_entry</span><span class="crayon-sy">(</span><span class="crayon-v">p</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">inet_protosw</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">list</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-8"> </div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-9">
<span class="crayon-h">		</span><span class="crayon-c">/* Check the non-wild match. */</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-10">
<span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">protocol</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">answer</span><span class="crayon-o">-&gt;</span><span class="crayon-v">protocol</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-11">
<span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">protocol</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-v">IPPROTO_IP</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-12">
<span class="crayon-h">				</span><span class="crayon-st">break</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-13">
<span class="crayon-h">		</span><span class="crayon-sy">}</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-14">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-15">
<span class="crayon-h">	</span><span class="crayon-c">// 这边answer指的是SOCK_STREAM</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-16">
<span class="crayon-h">	</span><span class="crayon-v">sock</span><span class="crayon-o">-&gt;</span><span class="crayon-v">ops</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">answer</span><span class="crayon-o">-&gt;</span><span class="crayon-v">ops</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-17">
<span class="crayon-h">	</span><span class="crayon-v">answer_no_check</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">answer</span><span class="crayon-o">-&gt;</span><span class="crayon-v">no_check</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-18">
<span class="crayon-h">	</span><span class="crayon-c">// 这边sk-&gt;prot就是answer_prot=&gt;tcp_prot</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-19">
<span class="crayon-h">	</span><span class="crayon-v">sk</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sk_alloc</span><span class="crayon-sy">(</span><span class="crayon-v">net</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">PF_INET</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">GFP_KERNEL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">answer_prot</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-20">
<span class="crayon-h">	</span><span class="crayon-e">sock_init_data</span><span class="crayon-sy">(</span><span class="crayon-v">sock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sk</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f057911869488-21">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f057911869488-22"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0038 seconds] -->
<p>上面的代码就是在INET中寻找SOCK_STREAM的过程了 我们再看一下inetsw[SOCK_STREAM]的具体配置:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f05a057696629" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
static struct inet_protosw inetsw_array[] =
{
	{
		.type =       SOCK_STREAM,
		.protocol =   IPPROTO_TCP,
		.prot =       &amp;tcp_prot,
		.ops =        &amp;inet_stream_ops,
		.capability = -1,
		.no_check =   0,
		.flags =      INET_PROTOSW_PERMANENT |
			      INET_PROTOSW_ICSK,
	},
	......
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f05a057696629-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05a057696629-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f05a057696629-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05a057696629-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f05a057696629-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05a057696629-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f05a057696629-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05a057696629-8">8</div>
<div class="crayon-num" data-line="crayon-5ad811534f05a057696629-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05a057696629-10">10</div>
<div class="crayon-num" data-line="crayon-5ad811534f05a057696629-11">11</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05a057696629-12">12</div>
<div class="crayon-num" data-line="crayon-5ad811534f05a057696629-13">13</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05a057696629-14">14</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f05a057696629-1">
<span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-e">inet_protosw </span><span class="crayon-v">inetsw_array</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05a057696629-2"><span class="crayon-sy">{</span></div>
<div class="crayon-line" id="crayon-5ad811534f05a057696629-3">
<span class="crayon-h">	</span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05a057696629-4">
<span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-v">type</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">       </span><span class="crayon-v">SOCK_STREAM</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f05a057696629-5">
<span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-v">protocol</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">   </span><span class="crayon-v">IPPROTO_TCP</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05a057696629-6">
<span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-v">prot</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">       </span><span class="crayon-o">&amp;</span><span class="crayon-v">tcp_prot</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f05a057696629-7">
<span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-v">ops</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">        </span><span class="crayon-o">&amp;</span><span class="crayon-v">inet_stream_ops</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05a057696629-8">
<span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-v">capability</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f05a057696629-9">
<span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-v">no_check</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">   </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05a057696629-10">
<span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-v">flags</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">      </span><span class="crayon-v">INET_PROTOSW_PERMANENT</span><span class="crayon-h"> </span><span class="crayon-o">|</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f05a057696629-11">
<span class="crayon-h">			      </span><span class="crayon-v">INET_PROTOSW_ICSK</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05a057696629-12">
<span class="crayon-h">	</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f05a057696629-13">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05a057696629-14"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->
<p>这边也用了重载，AF_INET有TCP、UDP以及Raw三种:</p>
<p><img src="/images/jobbole.com/e5e99f4d674862051cc71c6cc4dceea5.jpg"></p>
<p>从上述代码，我们可以清楚的发现sock-&gt;ops=&amp;inet_stream_ops;</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f05e018963274" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
const struct proto_ops inet_stream_ops = {
	.family		   = PF_INET,
	.owner		   = THIS_MODULE,
	......
	.sendmsg	   = tcp_sendmsg,
	.recvmsg	   = sock_common_recvmsg,
	......
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f05e018963274-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05e018963274-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f05e018963274-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05e018963274-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f05e018963274-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05e018963274-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f05e018963274-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f05e018963274-8">8</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f05e018963274-1">
<span class="crayon-r">const</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-e">proto_ops </span><span class="crayon-v">inet_stream_ops</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05e018963274-2">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">family</span><span class="crayon-h">		   </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">PF_INET</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f05e018963274-3">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">owner</span><span class="crayon-h">		   </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">THIS_MODULE</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05e018963274-4">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f05e018963274-5">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">sendmsg</span><span class="crayon-h">	   </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tcp_sendmsg</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05e018963274-6">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">recvmsg</span><span class="crayon-h">	   </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sock_common_recvmsg</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f05e018963274-7">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f05e018963274-8"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->
<p>即sock-&gt;ops-&gt;recvmsg = sock_common_recvmsg;<br>
同时sock-&gt;sk-&gt;sk_prot = tcp_prot;</p>
<p>我们再看下tcp_prot中的各个函数重载的定义:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f062625841716" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
struct proto tcp_prot = {
	.name			= "TCP",
	.close			= tcp_close,
	.connect		= tcp_v4_connect,
	.disconnect		= tcp_disconnect,
	.accept			= inet_csk_accept,
	......
	// 我们重点考察tcp的读
	.recvmsg		= tcp_recvmsg,
	......
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f062625841716-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f062625841716-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f062625841716-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f062625841716-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f062625841716-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f062625841716-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f062625841716-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f062625841716-8">8</div>
<div class="crayon-num" data-line="crayon-5ad811534f062625841716-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f062625841716-10">10</div>
<div class="crayon-num" data-line="crayon-5ad811534f062625841716-11">11</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f062625841716-1">
<span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-e">proto </span><span class="crayon-v">tcp_prot</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f062625841716-2">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-h">			</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"TCP"</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f062625841716-3">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">close</span><span class="crayon-h">			</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tcp_close</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f062625841716-4">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">connect</span><span class="crayon-h">		</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tcp_v4_connect</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f062625841716-5">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">disconnect</span><span class="crayon-h">		</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tcp_disconnect</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f062625841716-6">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">accept</span><span class="crayon-h">			</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">inet_csk_accept</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f062625841716-7">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f062625841716-8">
<span class="crayon-h">	</span><span class="crayon-c">// 我们重点考察tcp的读</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f062625841716-9">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">recvmsg</span><span class="crayon-h">		</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tcp_recvmsg</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f062625841716-10">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f062625841716-11"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->
<p></p>
<h2 id="h2_3">fcntl控制socket的阻塞\非阻塞状态</h2>
<p>我们用fcntl修改socket的阻塞\非阻塞状态。 事实上: fcntl的作用就是将O_NONBLOCK标志位存储在sock_fd对应的filp结构的f_lags里,如下图所示。</p>
<p><img src="/images/jobbole.com/4154689d84c9813900d6221a9b5f84d4.jpg"></p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f065176777754" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
fcntl(sock_fd, F_SETFL, fdflags | O_NONBLOCK);
	|-&gt;setfl</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f065176777754-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f065176777754-2">2</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f065176777754-1">
<span class="crayon-e">fcntl</span><span class="crayon-sy">(</span><span class="crayon-v">sock_fd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">F_SETFL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">fdflags</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">O_NONBLOCK</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f065176777754-2">
<span class="crayon-h">	</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">setfl</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>追踪setfl代码:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f068589305537" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
static int setfl(int fd, struct file * filp, unsigned long arg) {
	......
	filp-&gt;f_flags = (arg &amp; SETFL_MASK) | (filp-&gt;f_flags &amp; ~SETFL_MASK);
	......
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f068589305537-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f068589305537-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f068589305537-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f068589305537-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f068589305537-5">5</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f068589305537-1">
<span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">setfl</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">fd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">filp</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">arg</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f068589305537-2">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f068589305537-3">
<span class="crayon-h">	</span><span class="crayon-v">filp</span><span class="crayon-o">-&gt;</span><span class="crayon-v">f_flags</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">arg</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-v">SETFL_MASK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">filp</span><span class="crayon-o">-&gt;</span><span class="crayon-v">f_flags</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-v">SETFL_MASK</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f068589305537-4">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f068589305537-5"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->
<p>上图中，由sock_fd在task_struct(进程结构体)-&gt;files_struct-&gt;fd_array中找到对应的socket的file描述符，再修改file-&gt;flags</p>
<h2 id="h2_4">在调用socket.recv的时候</h2>
<p>我们跟踪源码调用:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f06c988473283" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
socket.recv
	|-&gt;sys_recv
		|-&gt;sys_recvfrom
			|-&gt;sock_recvmsg
				|-&gt;__sock_recvmsg
					|-&gt;sock-&gt;ops-&gt;recvmsg</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f06c988473283-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f06c988473283-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f06c988473283-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f06c988473283-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f06c988473283-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f06c988473283-6">6</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f06c988473283-1">
<span class="crayon-v">socket</span><span class="crayon-sy">.</span><span class="crayon-v">recv</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f06c988473283-2">
<span class="crayon-h">	</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sys_recv</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f06c988473283-3">
<span class="crayon-h">		</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sys_recvfrom</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f06c988473283-4">
<span class="crayon-h">			</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sock_recvmsg</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f06c988473283-5">
<span class="crayon-h">				</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">__sock_recvmsg</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f06c988473283-6">
<span class="crayon-h">					</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sock</span><span class="crayon-o">-&gt;</span><span class="crayon-v">ops</span><span class="crayon-o">-&gt;</span><span class="crayon-v">recvmsg</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>由上文可知: sock-&gt;ops-&gt;recvmsg = sock_common_recvmsg;</p>
<h3 id="h3_5">sock</h3>
<p>值得注意的是,在sock_recmsg中,有对标识O_NONBLOCK的处理</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f06f062029711" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
	if (sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK)
		flags |= MSG_DONTWAIT;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f06f062029711-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f06f062029711-2">2</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f06f062029711-1">
<span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">sock</span><span class="crayon-o">-&gt;</span><span class="crayon-v">file</span><span class="crayon-o">-&gt;</span><span class="crayon-v">f_flags</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-v">O_NONBLOCK</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f06f062029711-2">
<span class="crayon-h">		</span><span class="crayon-v">flags</span><span class="crayon-h"> </span><span class="crayon-o">|=</span><span class="crayon-h"> </span><span class="crayon-v">MSG_DONTWAIT</span><span class="crayon-sy">;</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
<p>上述代码中sock关联的file中获取其f_flags,如果flags有O_NONBLOCK标识，那么就设置msg_flags为MSG_DONTWAIT(不等待)。<br>
fcntl与socket就是通过其共同操作File结构关联起来的。</p>
<h3 id="h3_6">继续跟踪调用</h3>
<p>sock_common_recvmsg</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f072205429243" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
int sock_common_recvmsg(struct kiocb *iocb, struct socket *sock,
			struct msghdr *msg, size_t size, int flags) {
	......
	// 如果flags的MSG_DONTWAIT标识置位，则传给recvmsg的第5个参数为正,否则为0
	err = sk-&gt;sk_prot-&gt;recvmsg(iocb, sk, msg, size, flags &amp; MSG_DONTWAIT,
				   flags &amp; ~MSG_DONTWAIT, &amp;addr_len);
	.....				   
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f072205429243-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f072205429243-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f072205429243-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f072205429243-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f072205429243-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f072205429243-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f072205429243-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f072205429243-8">8</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f072205429243-1">
<span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">sock_common_recvmsg</span><span class="crayon-sy">(</span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-e ">kiocb *</span><span class="crayon-v">iocb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-e ">socket *</span><span class="crayon-v">sock</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f072205429243-2">
<span class="crayon-h">			</span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-e ">msghdr *</span><span class="crayon-v">msg</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">size_t </span><span class="crayon-v">size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">flags</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f072205429243-3">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f072205429243-4">
<span class="crayon-h">	</span><span class="crayon-c">// 如果flags的MSG_DONTWAIT标识置位，则传给recvmsg的第5个参数为正,否则为0</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f072205429243-5">
<span class="crayon-h">	</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_prot</span><span class="crayon-o">-&gt;</span><span class="crayon-e">recvmsg</span><span class="crayon-sy">(</span><span class="crayon-v">iocb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sk</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">msg</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">flags</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-v">MSG_DONTWAIT</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f072205429243-6">
<span class="crayon-h">				   </span><span class="crayon-v">flags</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-v">MSG_DONTWAIT</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">addr_len</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f072205429243-7">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h">				   </span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f072205429243-8"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->
<p>由上文可知: sk-&gt;sk_prot-&gt;recvmsg 其中sk_prot=tcp_prot,即最终调用的是tcp_prot-&gt;tcp_recvmsg,<br>
上面的代码可以看出，如果fcntl(O_NONBLOCK)=&gt;MSG_DONTWAIT置位=&gt;(flags &amp; MSG_DONTWAIT)&gt;0, 再结合tcp_recvmsg的函数签名,即如果设置了O_NONBLOCK的话，设置给tcp_recvmsg的nonblock参数&gt;0,关系如下图所示:</p>
<p><img src="/images/jobbole.com/922d2133d26b7e8cd28adbb0c85b5c2c.jpg"></p>
<h3 id="h3_7">最终的调用逻辑tcp_recvmsg</h3>
<p>首先我们看下tcp_recvmsg的函数签名:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f076883309894" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
int tcp_recvmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,
		size_t len, int nonblock, int flags, int *addr_len)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f076883309894-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f076883309894-2">2</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f076883309894-1">
<span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">tcp_recvmsg</span><span class="crayon-sy">(</span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">kiocb</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">iocb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">sock</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">sk</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">msghdr</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">msg</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f076883309894-2">
<span class="crayon-h">		</span><span class="crayon-e">size_t </span><span class="crayon-v">len</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">nonblock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">flags</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">addr_len</span><span class="crayon-sy">)</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>显然我们关注焦点在(int nonblock这个参数上):</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f079908682298" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
int tcp_recvmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,
		size_t len, int nonblock, int flags, int *addr_len){
	......	
	// copied是指向用户空间拷贝了多少字节，即读了多少
	int copied;
	// target指的是期望多少字节
	int target;
	// 等效为timo = noblock ? 0 : sk-&gt;sk_rcvtimeo;
	timeo = sock_rcvtimeo(sk, nonblock);
	......	
	// 如果设置了MSG_WAITALL标识target=需要读的长度
	// 如果未设置，则为最低低水位值
	target = sock_rcvlowat(sk, flags &amp; MSG_WAITALL, len);
	......

	do{
		// 表明读到数据
		if (copied) {
			// 注意，这边只要!timeo，即nonblock设置了就会跳出循环
			if (sk-&gt;sk_err ||
			    sk-&gt;sk_state == TCP_CLOSE ||
			    (sk-&gt;sk_shutdown &amp; RCV_SHUTDOWN) ||
			    !timeo ||
			    signal_pending(current) ||
			    (flags &amp; MSG_PEEK))
			break;
		}else{
			// 到这里，表明没有读到任何数据
			// 且nonblock设置了导致timeo=0，则返回-EAGAIN,符合我们的预期
			if (!timeo) {
				copied = -EAGAIN;
				break;
		}
		// 这边如果堵到了期望的数据，继续，否则当前进程阻塞在sk_wait_data上
		if (copied &gt;= target) {
			/* Do not sleep, just process backlog. */
			release_sock(sk);
			lock_sock(sk);
		} else
			sk_wait_data(sk, &amp;timeo);
	} while (len &gt; 0);		
	......
	return copied
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-8">8</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-10">10</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-11">11</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-12">12</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-13">13</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-14">14</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-15">15</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-16">16</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-17">17</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-18">18</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-19">19</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-20">20</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-21">21</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-22">22</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-23">23</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-24">24</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-25">25</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-26">26</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-27">27</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-28">28</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-29">29</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-30">30</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-31">31</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-32">32</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-33">33</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-34">34</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-35">35</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-36">36</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-37">37</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-38">38</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-39">39</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-40">40</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-41">41</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-42">42</div>
<div class="crayon-num" data-line="crayon-5ad811534f079908682298-43">43</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f079908682298-44">44</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f079908682298-1">
<span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">tcp_recvmsg</span><span class="crayon-sy">(</span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">kiocb</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">iocb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">sock</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">sk</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">msghdr</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">msg</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-2">
<span class="crayon-h">		</span><span class="crayon-e">size_t </span><span class="crayon-v">len</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">nonblock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">flags</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">addr_len</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-3">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h">	</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-4">
<span class="crayon-h">	</span><span class="crayon-c">// copied是指向用户空间拷贝了多少字节，即读了多少</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-5">
<span class="crayon-h">	</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">copied</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-6">
<span class="crayon-h">	</span><span class="crayon-c">// target指的是期望多少字节</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-7">
<span class="crayon-h">	</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">target</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-8">
<span class="crayon-h">	</span><span class="crayon-c">// 等效为timo = noblock ? 0 : sk-&gt;sk_rcvtimeo;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-9">
<span class="crayon-h">	</span><span class="crayon-v">timeo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sock_rcvtimeo</span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nonblock</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-10">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h">	</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-11">
<span class="crayon-h">	</span><span class="crayon-c">// 如果设置了MSG_WAITALL标识target=需要读的长度</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-12">
<span class="crayon-h">	</span><span class="crayon-c">// 如果未设置，则为最低低水位值</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-13">
<span class="crayon-h">	</span><span class="crayon-v">target</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sock_rcvlowat</span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">flags</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-v">MSG_WAITALL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">len</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-14">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-15"> </div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-16">
<span class="crayon-h">	</span><span class="crayon-st">do</span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-17">
<span class="crayon-h">		</span><span class="crayon-c">// 表明读到数据</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-18">
<span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">copied</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-19">
<span class="crayon-h">			</span><span class="crayon-c">// 注意，这边只要!timeo，即nonblock设置了就会跳出循环</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-20">
<span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_err</span><span class="crayon-h"> </span><span class="crayon-o">||</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-21">
<span class="crayon-h">			    </span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_state</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">TCP_CLOSE</span><span class="crayon-h"> </span><span class="crayon-o">||</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-22">
<span class="crayon-h">			    </span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_shutdown</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-v">RCV_SHUTDOWN</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">||</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-23">
<span class="crayon-h">			    </span><span class="crayon-o">!</span><span class="crayon-v">timeo</span><span class="crayon-h"> </span><span class="crayon-o">||</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-24">
<span class="crayon-h">			    </span><span class="crayon-e">signal_pending</span><span class="crayon-sy">(</span><span class="crayon-v">current</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">||</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-25">
<span class="crayon-h">			    </span><span class="crayon-sy">(</span><span class="crayon-v">flags</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-v">MSG_PEEK</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-26">
<span class="crayon-h">			</span><span class="crayon-st">break</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-27">
<span class="crayon-h">		</span><span class="crayon-sy">}</span><span class="crayon-st">else</span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-28">
<span class="crayon-h">			</span><span class="crayon-c">// 到这里，表明没有读到任何数据</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-29">
<span class="crayon-h">			</span><span class="crayon-c">// 且nonblock设置了导致timeo=0，则返回-EAGAIN,符合我们的预期</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-30">
<span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">timeo</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-31">
<span class="crayon-h">				</span><span class="crayon-v">copied</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">EAGAIN</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-32">
<span class="crayon-h">				</span><span class="crayon-st">break</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-33">
<span class="crayon-h">		</span><span class="crayon-sy">}</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-34">
<span class="crayon-h">		</span><span class="crayon-c">// 这边如果堵到了期望的数据，继续，否则当前进程阻塞在sk_wait_data上</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-35">
<span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">copied</span><span class="crayon-h"> </span><span class="crayon-o">&gt;=</span><span class="crayon-h"> </span><span class="crayon-v">target</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-36">
<span class="crayon-h">			</span><span class="crayon-c">/* Do not sleep, just process backlog. */</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-37">
<span class="crayon-h">			</span><span class="crayon-e">release_sock</span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-38">
<span class="crayon-h">			</span><span class="crayon-e">lock_sock</span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-39">
<span class="crayon-h">		</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-40">
<span class="crayon-h">			</span><span class="crayon-e">sk_wait_data</span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">timeo</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-41">
<span class="crayon-h">	</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">len</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">		</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-42">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f079908682298-43">
<span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-i">copied</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f079908682298-44"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0064 seconds] -->
<p>上面的逻辑归结起来就是：<br>
(1)在设置了nonblock的时候，如果copied&gt;0,则返回读了多少字节,如果copied=0，则返回-EAGAIN,提示应用重复调用。<br>
(2)如果没有设置nonblock，如果读取的数据&gt;=期望，则返回读取了多少字节。如果没有则用sk_wait_data将当前进程等待。<br>
如下流程图所示:</p>
<p><img src="/images/jobbole.com/0f4390b61a016f52b8135529f2496336.jpg"></p>
<h3 id="h3_8">阻塞函数sk_wait_data</h3>
<p>sk_wait_data代码-函数为:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f07d588108332" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
	// 将进程状态设置为可打断INTERRUPTIBLE
	prepare_to_wait(sk-&gt;sk_sleep, &amp;wait, TASK_INTERRUPTIBLE);
	set_bit(SOCK_ASYNC_WAITDATA, &amp;sk-&gt;sk_socket-&gt;flags);
	// 通过调用schedule_timeout让出CPU，然后进行睡眠
	rc = sk_wait_event(sk, timeo, !skb_queue_empty(&amp;sk-&gt;sk_receive_queue));
	// 到这里的时候，有网络事件或超时事件唤醒了此进程，继续运行
	clear_bit(SOCK_ASYNC_WAITDATA, &amp;sk-&gt;sk_socket-&gt;flags);
	finish_wait(sk-&gt;sk_sleep, &amp;wait);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f07d588108332-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f07d588108332-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f07d588108332-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f07d588108332-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f07d588108332-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f07d588108332-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f07d588108332-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f07d588108332-8">8</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f07d588108332-1">
<span class="crayon-h">	</span><span class="crayon-c">// 将进程状态设置为可打断INTERRUPTIBLE</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f07d588108332-2">
<span class="crayon-h">	</span><span class="crayon-e">prepare_to_wait</span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_sleep</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">wait</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">TASK_INTERRUPTIBLE</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f07d588108332-3">
<span class="crayon-h">	</span><span class="crayon-e">set_bit</span><span class="crayon-sy">(</span><span class="crayon-v">SOCK_ASYNC_WAITDATA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_socket</span><span class="crayon-o">-&gt;</span><span class="crayon-v">flags</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f07d588108332-4">
<span class="crayon-h">	</span><span class="crayon-c">// 通过调用schedule_timeout让出CPU，然后进行睡眠</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f07d588108332-5">
<span class="crayon-h">	</span><span class="crayon-v">rc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sk_wait_event</span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">timeo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-e">skb_queue_empty</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_receive_queue</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f07d588108332-6">
<span class="crayon-h">	</span><span class="crayon-c">// 到这里的时候，有网络事件或超时事件唤醒了此进程，继续运行</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f07d588108332-7">
<span class="crayon-h">	</span><span class="crayon-e">clear_bit</span><span class="crayon-sy">(</span><span class="crayon-v">SOCK_ASYNC_WAITDATA</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_socket</span><span class="crayon-o">-&gt;</span><span class="crayon-v">flags</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f07d588108332-8">
<span class="crayon-h">	</span><span class="crayon-e">finish_wait</span><span class="crayon-sy">(</span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_sleep</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">wait</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->
<p>该函数调用schedule_timeout进入睡眠，其进一步调用了schedule函数，首先从运行队列删除，其次加入到等待队列，最后调用和体系结构相关的switch_to宏来完成进程间的切换。<br>
如下图所示:</p>
<p><img src="/images/jobbole.com/a46f78d6f0ca9d1a9f9fb8cdf1d9a2e3.jpg"></p>
<h3 id="h3_9">阻塞后什么时候恢复运行呢</h3>
<h4 id="h4_10">情况1:有对应的网络数据到来</h4>
<p>首先我们看下网络分组到来的内核路径，网卡发起中断后调用netif_rx将事件挂入CPU的等待队列，并唤起软中断(soft_irq)，再通过linux的软中断机制调用net_rx_action，如下图所示:</p>
<p><img src="/images/jobbole.com/1878d8b3db0d5e69c600c15a0d220522.jpg"></p>
<p>注:上图来自PLKA(&lt;&lt;深入Linux内核架构&gt;&gt;)<br>
紧接着跟踪next_rx_action</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f081988592299" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
next_rx_action
	|-process_backlog
		......
			|-&gt;packet_type-&gt;func 在这里我们考虑ip_rcv
					|-&gt;ipprot-&gt;handler 在这里ipprot重载为tcp_protocol
						(handler 即为tcp_v4_rcv)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f081988592299-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f081988592299-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f081988592299-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f081988592299-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f081988592299-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f081988592299-6">6</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f081988592299-1"><span class="crayon-v">next_rx_action</span></div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f081988592299-2">
<span class="crayon-h">	</span><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-v">process</span><span class="crayon-sy">_</span>backlog</div>
<div class="crayon-line" id="crayon-5ad811534f081988592299-3">
<span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f081988592299-4">
<span class="crayon-h">			</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">packet_type</span><span class="crayon-o">-&gt;</span><span class="crayon-i">func</span><span class="crayon-h"> </span>在这里我们考虑<span class="crayon-v">ip_rcv</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f081988592299-5">
<span class="crayon-h">					</span><span class="crayon-o">|</span><span class="crayon-o">-&gt;</span><span class="crayon-v">ipprot</span><span class="crayon-o">-&gt;</span><span class="crayon-i">handler</span><span class="crayon-h"> </span>在这里<span class="crayon-i">ipprot</span>重载为<span class="crayon-e">tcp_protocol</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f081988592299-6">
<span class="crayon-h">						</span><span class="crayon-sy">(</span><span class="crayon-i">handler</span><span class="crayon-h"> </span>即为<span class="crayon-v">tcp_v4_rcv</span><span class="crayon-sy">)</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>紧接着tcp_v4_rcv:</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f085213663343" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
tcp_input.c
tcp_v4_rcv
	|-tcp_v4_do_rcv
		|-tcp_rcv_state_process
			|-tcp_data_queue
				|-sk-&gt;sk_data_ready=sock_def_readable
					|-wake_up_interruptible
						|-__wake_up
							|-__wake_up_common</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f085213663343-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f085213663343-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f085213663343-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f085213663343-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f085213663343-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f085213663343-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f085213663343-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f085213663343-8">8</div>
<div class="crayon-num" data-line="crayon-5ad811534f085213663343-9">9</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f085213663343-1">
<span class="crayon-v">tcp_input</span><span class="crayon-sy">.</span><span class="crayon-i">c</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f085213663343-2"><span class="crayon-v">tcp_v4_rcv</span></div>
<div class="crayon-line" id="crayon-5ad811534f085213663343-3">
<span class="crayon-h">	</span><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-v">tcp_v4_do_rcv</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f085213663343-4">
<span class="crayon-h">		</span><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-v">tcp_rcv_state_process</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f085213663343-5">
<span class="crayon-h">			</span><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-v">tcp_data_queue</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f085213663343-6">
<span class="crayon-h">				</span><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-v">sk</span><span class="crayon-o">-&gt;</span><span class="crayon-v">sk_data_ready</span><span class="crayon-o">=</span><span class="crayon-v">sock_def_readable</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f085213663343-7">
<span class="crayon-h">					</span><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-v">wake_up_interruptible</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f085213663343-8">
<span class="crayon-h">						</span><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-v">__wake_up</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f085213663343-9">
<span class="crayon-h">							</span><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-v">__wake_up_common</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>在这里__wake_up_common将停在当前wait_queue_head_t中的进程唤醒，即状态改为task_running，等待CFS调度以进行下一步的动作,如下图所示。</p>
<p><img src="/images/jobbole.com/cde7a651a7abd5209bb2139b78b579ce.jpg"></p>
<h4 id="h4_11">情况2:设定的超时时间到来</h4>
<p>在前面调用sk_wait_event中调用了schedule_timeout</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f088352501322" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
fastcall signed long __sched schedule_timeout(signed long timeout) {
	......
	// 设定超时的回掉函数为process_timeout
	setup_timer(&amp;timer, process_timeout, (unsigned long)current);
	__mod_timer(&amp;timer, expire);
	// 这边让出CPU
	schedule();
	del_singleshot_timer_sync(&amp;timer);
	timeout = expire - jiffies;
 out:
 	// 返回经过了多长事件
	return timeout &lt; 0 ? 0 : timeout;	
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f088352501322-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f088352501322-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f088352501322-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f088352501322-4">4</div>
<div class="crayon-num" data-line="crayon-5ad811534f088352501322-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f088352501322-6">6</div>
<div class="crayon-num" data-line="crayon-5ad811534f088352501322-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f088352501322-8">8</div>
<div class="crayon-num" data-line="crayon-5ad811534f088352501322-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f088352501322-10">10</div>
<div class="crayon-num" data-line="crayon-5ad811534f088352501322-11">11</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f088352501322-12">12</div>
<div class="crayon-num" data-line="crayon-5ad811534f088352501322-13">13</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f088352501322-1">
<span class="crayon-e">fastcall </span><span class="crayon-t">signed</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-e">__sched </span><span class="crayon-e">schedule_timeout</span><span class="crayon-sy">(</span><span class="crayon-t">signed</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">timeout</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f088352501322-2">
<span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f088352501322-3">
<span class="crayon-h">	</span><span class="crayon-c">// 设定超时的回掉函数为process_timeout</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f088352501322-4">
<span class="crayon-h">	</span><span class="crayon-e">setup_timer</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">timer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">process_timeout</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-sy">)</span><span class="crayon-v">current</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f088352501322-5">
<span class="crayon-h">	</span><span class="crayon-e">__mod_timer</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">timer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">expire</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f088352501322-6">
<span class="crayon-h">	</span><span class="crayon-c">// 这边让出CPU</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f088352501322-7">
<span class="crayon-h">	</span><span class="crayon-e">schedule</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f088352501322-8">
<span class="crayon-h">	</span><span class="crayon-e">del_singleshot_timer_sync</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">timer</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f088352501322-9">
<span class="crayon-h">	</span><span class="crayon-v">timeout</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">expire</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">jiffies</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f088352501322-10">
<span class="crayon-h"> </span><span class="crayon-v">out</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f088352501322-11">
<span class="crayon-h"> 	</span><span class="crayon-c">// 返回经过了多长事件</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f088352501322-12">
<span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">timeout</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">timeout</span><span class="crayon-sy">;</span><span class="crayon-h">	</span>
</div>
<div class="crayon-line" id="crayon-5ad811534f088352501322-13"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0029 seconds] -->
<p>process_timeout函数即是将此进程重新唤醒</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-5ad811534f08c710835515" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
<span class="crayon-language">C</span>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
static void process_timeout(unsigned long __data)
{
	wake_up_process((struct task_struct *)__data);
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-5ad811534f08c710835515-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f08c710835515-2">2</div>
<div class="crayon-num" data-line="crayon-5ad811534f08c710835515-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-5ad811534f08c710835515-4">4</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-5ad811534f08c710835515-1">
<span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">process_timeout</span><span class="crayon-sy">(</span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">__data</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f08c710835515-2"><span class="crayon-sy">{</span></div>
<div class="crayon-line" id="crayon-5ad811534f08c710835515-3">
<span class="crayon-h">	</span><span class="crayon-e">wake_up_process</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">task_struct</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-v">__data</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-5ad811534f08c710835515-4"><span class="crayon-sy">}</span></div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->
<p></p>
<h2 id="h2_12">总结</h2>
<p>linux内核源代码博大精深，阅读其代码很费周折。希望笔者这篇文章能帮助到阅读linux网络协议栈代码的人。</p>

        
        
        
    




        <!-- BEGIN #author-bio -->


<!-- END #author-bio -->
	
{% endraw %}
