---
layout: post
title: '记录一次 MySQL 死锁排查过程'
time: 2017-02-20 00:00:00 +0800
site_name: jobbole.com
source_url: http://blog.jobbole.com/110301/
---
{% raw %}


        			<div class="textwidget">
</div>
		
		<h2 id="背景">背景</h2>
<p>以前接触到的数据库死锁，都是批量更新时加锁顺序不一致而导致的死锁，但是上周却遇到了一个很难理解的死锁。借着这个机会又重新学习了一下mysql的死锁知识以及常见的死锁场景。在多方调研以及和同事们的讨论下终于发现了这个死锁问题的成因，收获颇多。虽然是后端程序员，我们不需要像DBA一样深入地去分析与锁相关的源码，但是如果我们能够掌握基本的死锁排查方法，对我们的日常开发还是大有裨益的。</p>
<p>PS：本文不会介绍死锁的基本知识，mysql的加锁原理可以参考本文的参考资料提供的链接。</p>
<h2 id="死锁起因">死锁起因</h2>
<p>先介绍一下数据库和表情况，因为涉及到公司内部真是的数据，所以以下都做了模拟，不会影响具体的分析。</p>
<p>我们采用的是5.5版本的mysql数据库，事务隔离级别是默认的RR（Repeatable-Read），采用innodb引擎。假设存在test表：</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-58ac01242a314247804399" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" touchscreen minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
CREATE TABLE `test` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `a` int(11) unsigned DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `a` (`a`)
) ENGINE=InnoDB AUTO_INCREMENT=100 DEFAULT CHARSET=utf8;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-58ac01242a314247804399-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a314247804399-2">2</div>
<div class="crayon-num" data-line="crayon-58ac01242a314247804399-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a314247804399-4">4</div>
<div class="crayon-num" data-line="crayon-58ac01242a314247804399-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a314247804399-6">6</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-58ac01242a314247804399-1">
<span class="crayon-e">CREATE </span><span class="crayon-i">TABLE</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">test</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-sy">(</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a314247804399-2">
<span class="crayon-h">  </span><span class="crayon-sy">`</span><span class="crayon-v">id</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">(</span><span class="crayon-cn">11</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-st">NOT</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-h"> </span><span class="crayon-v">AUTO_INCREMENT</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a314247804399-3">
<span class="crayon-h">  </span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">(</span><span class="crayon-cn">11</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-st">DEFAULT</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a314247804399-4">
<span class="crayon-h">  </span><span class="crayon-e">PRIMARY </span><span class="crayon-e">KEY</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">`</span><span class="crayon-v">id</span><span class="crayon-sy">`</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a314247804399-5">
<span class="crayon-h">  </span><span class="crayon-e">UNIQUE </span><span class="crayon-i">KEY</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a314247804399-6">
<span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">ENGINE</span><span class="crayon-o">=</span><span class="crayon-e">InnoDB </span><span class="crayon-v">AUTO_INCREMENT</span><span class="crayon-o">=</span><span class="crayon-cn">100</span><span class="crayon-h"> </span><span class="crayon-st">DEFAULT</span><span class="crayon-h"> </span><span class="crayon-v">CHARSET</span><span class="crayon-o">=</span><span class="crayon-v">utf8</span><span class="crayon-sy">;</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->
<p>表的结构很简单，一个主键id，另一个唯一索引a。表里的数据如下：</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-58ac01242a31d736862839" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" touchscreen minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
mysql&gt; select * from test;
+----+------+
| id | a    |
+----+------+
|  1 |    1 |
|  2 |    2 |
|  4 |    4 |
+----+------+
3 rows in set (0.00 sec)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-58ac01242a31d736862839-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a31d736862839-2">2</div>
<div class="crayon-num" data-line="crayon-58ac01242a31d736862839-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a31d736862839-4">4</div>
<div class="crayon-num" data-line="crayon-58ac01242a31d736862839-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a31d736862839-6">6</div>
<div class="crayon-num" data-line="crayon-58ac01242a31d736862839-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a31d736862839-8">8</div>
<div class="crayon-num" data-line="crayon-58ac01242a31d736862839-9">9</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-58ac01242a31d736862839-1">
<span class="crayon-v">mysql</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e ">select *</span><span class="crayon-h"> </span><span class="crayon-e">from </span><span class="crayon-v">test</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a31d736862839-2">
<span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">+</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a31d736862839-3">
<span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">a</span><span class="crayon-h">    </span><span class="crayon-o">|</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a31d736862839-4">
<span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">+</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a31d736862839-5">
<span class="crayon-o">|</span><span class="crayon-h">  </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">    </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">|</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a31d736862839-6">
<span class="crayon-o">|</span><span class="crayon-h">  </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">    </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-o">|</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a31d736862839-7">
<span class="crayon-o">|</span><span class="crayon-h">  </span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">    </span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-o">|</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a31d736862839-8">
<span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">+</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">+</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a31d736862839-9">
<span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">rows </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0.00</span><span class="crayon-h"> </span><span class="crayon-v">sec</span><span class="crayon-sy">)</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>出现死锁的操作如下：</p>
<table>
<thead>
<tr>
<th>步骤</th>
<th>事务1</th>
<th>事务2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
<td>begin</td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>delete from test where a = 2;</td>
</tr>
<tr>
<td>3</td>
<td>begin</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>delete from test where a = 2; （事务1卡住）</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>提示出现死锁：ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</td>
<td>insert into test (id, a) values (10, 2);</td>
</tr>
</tbody>
</table>
<p><a id="more"></a>然后我们可以通过<code>SHOW ENGINE INNODB STATUS;</code>来查看死锁日志：</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-58ac01242a321330410158" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" touchscreen minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
------------------------
LATEST DETECTED DEADLOCK
------------------------
170219 13:31:31
*** (1) TRANSACTION:
TRANSACTION 2A8BD, ACTIVE 11 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 2 lock struct(s), heap size 376, 1 row lock(s)
MySQL thread id 448218, OS thread handle 0x2abe5fb5d700, query id 18923238 renjun.fangcloud.net 121.41.41.92 root updating
delete from test where a = 2
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BD lock_mode X waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32
 0: len 4; hex 00000002; asc     ;;
 1: len 4; hex 00000002; asc     ;;
*** (2) TRANSACTION:
TRANSACTION 2A8BC, ACTIVE 18 sec inserting
mysql tables in use 1, locked 1
4 lock struct(s), heap size 1248, 3 row lock(s), undo log entries 2
MySQL thread id 448217, OS thread handle 0x2abe5fd65700, query id 18923239 renjun.fangcloud.net 121.41.41.92 root update
insert into test (id,a) values (10,2)
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BC lock_mode X locks rec but not gap
Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32
 0: len 4; hex 00000002; asc     ;;
 1: len 4; hex 00000002; asc     ;;
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BC lock mode S waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32
 0: len 4; hex 00000002; asc     ;;
 1: len 4; hex 00000002; asc     ;;
*** WE ROLL BACK TRANSACTION (1)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-2">2</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-4">4</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-6">6</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-8">8</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-10">10</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-11">11</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-12">12</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-13">13</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-14">14</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-15">15</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-16">16</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-17">17</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-18">18</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-19">19</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-20">20</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-21">21</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-22">22</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-23">23</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-24">24</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-25">25</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-26">26</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-27">27</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-28">28</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-29">29</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-30">30</div>
<div class="crayon-num" data-line="crayon-58ac01242a321330410158-31">31</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a321330410158-32">32</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-58ac01242a321330410158-1">
<span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-2">
<span class="crayon-e">LATEST </span><span class="crayon-e">DETECTED </span><span class="crayon-v">DEADLOCK</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-3">
<span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-4">
<span class="crayon-cn">170219</span><span class="crayon-h"> </span><span class="crayon-cn">13</span><span class="crayon-o">:</span><span class="crayon-cn">31</span><span class="crayon-o">:</span><span class="crayon-cn">31</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-5">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">TRANSACTION</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-6">
<span class="crayon-i">TRANSACTION</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BD</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">ACTIVE</span><span class="crayon-h"> </span><span class="crayon-cn">11</span><span class="crayon-h"> </span><span class="crayon-e">sec </span><span class="crayon-e">starting </span><span class="crayon-e">index </span><span class="crayon-e">read</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-7">
<span class="crayon-e">mysql </span><span class="crayon-e">tables </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-st">use</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">locked</span><span class="crayon-h"> </span><span class="crayon-cn">1</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-8">
<span class="crayon-e">LOCK </span><span class="crayon-i">WAIT</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-e">lock </span><span class="crayon-t">struct</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">size</span><span class="crayon-h"> </span><span class="crayon-cn">376</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-e">lock</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-9">
<span class="crayon-e">MySQL </span><span class="crayon-e">thread </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">448218</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">OS </span><span class="crayon-e">thread </span><span class="crayon-i">handle</span><span class="crayon-h"> </span><span class="crayon-cn">0x2abe5fb5d700</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">query </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">18923238</span><span class="crayon-h"> </span><span class="crayon-v">renjun</span><span class="crayon-sy">.</span><span class="crayon-v">fangcloud</span><span class="crayon-sy">.</span><span class="crayon-i">net</span><span class="crayon-h"> </span><span class="crayon-cn">121.41.41.92</span><span class="crayon-h"> </span><span class="crayon-e">root </span><span class="crayon-e">updating</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-10">
<span class="crayon-e">delete </span><span class="crayon-e">from </span><span class="crayon-e">test </span><span class="crayon-i">where</span><span class="crayon-h"> </span><span class="crayon-v">a</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-11">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">WAITING </span><span class="crayon-st">FOR</span><span class="crayon-h"> </span><span class="crayon-r">THIS</span><span class="crayon-h"> </span><span class="crayon-e">LOCK </span><span class="crayon-st">TO</span><span class="crayon-h"> </span><span class="crayon-e">BE </span><span class="crayon-v">GRANTED</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-12">
<span class="crayon-e">RECORD </span><span class="crayon-e">LOCKS </span><span class="crayon-e">space </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">page </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">923</span><span class="crayon-h"> </span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">80</span><span class="crayon-h"> </span><span class="crayon-i">index</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">of </span><span class="crayon-i">table</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">oauthdemo</span><span class="crayon-sy">`</span><span class="crayon-sy">.</span><span class="crayon-sy">`</span><span class="crayon-v">test</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">trx </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BD</span><span class="crayon-h"> </span><span class="crayon-v">lock</span><span class="crayon-sy">_</span>mode<span class="crayon-h"> </span><span class="crayon-i">X</span><span class="crayon-h"> </span><span class="crayon-e">waiting</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-13">
<span class="crayon-e">Record </span><span class="crayon-v">lock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">PHYSICAL </span><span class="crayon-v">RECORD</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">_</span>fields<span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">compact </span><span class="crayon-v">format</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">info </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">32</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-14">
<span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-15">
<span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-16">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">TRANSACTION</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-17">
<span class="crayon-i">TRANSACTION</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BC</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">ACTIVE</span><span class="crayon-h"> </span><span class="crayon-cn">18</span><span class="crayon-h"> </span><span class="crayon-e">sec </span><span class="crayon-e">inserting</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-18">
<span class="crayon-e">mysql </span><span class="crayon-e">tables </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-st">use</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">locked</span><span class="crayon-h"> </span><span class="crayon-cn">1</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-19">
<span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-e">lock </span><span class="crayon-t">struct</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">size</span><span class="crayon-h"> </span><span class="crayon-cn">1248</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-e">lock</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">undo </span><span class="crayon-e">log </span><span class="crayon-i">entries</span><span class="crayon-h"> </span><span class="crayon-cn">2</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-20">
<span class="crayon-e">MySQL </span><span class="crayon-e">thread </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">448217</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">OS </span><span class="crayon-e">thread </span><span class="crayon-i">handle</span><span class="crayon-h"> </span><span class="crayon-cn">0x2abe5fd65700</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">query </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">18923239</span><span class="crayon-h"> </span><span class="crayon-v">renjun</span><span class="crayon-sy">.</span><span class="crayon-v">fangcloud</span><span class="crayon-sy">.</span><span class="crayon-i">net</span><span class="crayon-h"> </span><span class="crayon-cn">121.41.41.92</span><span class="crayon-h"> </span><span class="crayon-e">root </span><span class="crayon-e">update</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-21">
<span class="crayon-e">insert </span><span class="crayon-e">into </span><span class="crayon-e">test</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">id</span><span class="crayon-sy">,</span><span class="crayon-v">a</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">values</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">,</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-22">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">HOLDS </span><span class="crayon-e">THE </span><span class="crayon-e">LOCK</span><span class="crayon-sy">(</span><span class="crayon-v">S</span><span class="crayon-sy">)</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-23">
<span class="crayon-e">RECORD </span><span class="crayon-e">LOCKS </span><span class="crayon-e">space </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">page </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">923</span><span class="crayon-h"> </span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">80</span><span class="crayon-h"> </span><span class="crayon-i">index</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">of </span><span class="crayon-i">table</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">oauthdemo</span><span class="crayon-sy">`</span><span class="crayon-sy">.</span><span class="crayon-sy">`</span><span class="crayon-v">test</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">trx </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BC</span><span class="crayon-h"> </span><span class="crayon-v">lock</span><span class="crayon-sy">_</span>mode<span class="crayon-h"> </span><span class="crayon-i">X</span><span class="crayon-h"> </span><span class="crayon-e">locks </span><span class="crayon-e">rec </span><span class="crayon-e">but </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">gap</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-24">
<span class="crayon-e">Record </span><span class="crayon-v">lock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">PHYSICAL </span><span class="crayon-v">RECORD</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">_</span>fields<span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">compact </span><span class="crayon-v">format</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">info </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">32</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-25">
<span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-26">
<span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-27">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">WAITING </span><span class="crayon-st">FOR</span><span class="crayon-h"> </span><span class="crayon-r">THIS</span><span class="crayon-h"> </span><span class="crayon-e">LOCK </span><span class="crayon-st">TO</span><span class="crayon-h"> </span><span class="crayon-e">BE </span><span class="crayon-v">GRANTED</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-28">
<span class="crayon-e">RECORD </span><span class="crayon-e">LOCKS </span><span class="crayon-e">space </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">page </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">923</span><span class="crayon-h"> </span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">80</span><span class="crayon-h"> </span><span class="crayon-i">index</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">of </span><span class="crayon-i">table</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">oauthdemo</span><span class="crayon-sy">`</span><span class="crayon-sy">.</span><span class="crayon-sy">`</span><span class="crayon-v">test</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">trx </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BC</span><span class="crayon-h"> </span><span class="crayon-e">lock </span><span class="crayon-i">mode</span><span class="crayon-h"> </span><span class="crayon-i">S</span><span class="crayon-h"> </span><span class="crayon-e">waiting</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-29">
<span class="crayon-e">Record </span><span class="crayon-v">lock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">PHYSICAL </span><span class="crayon-v">RECORD</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">_</span>fields<span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">compact </span><span class="crayon-v">format</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">info </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">32</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-30">
<span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a321330410158-31">
<span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a321330410158-32">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-e">WE </span><span class="crayon-e">ROLL </span><span class="crayon-e">BACK </span><span class="crayon-e">TRANSACTION</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0119 seconds] -->
<p></p>
<h2 id="分析">分析</h2>
<h3 id="阅读死锁日志">阅读死锁日志</h3>
<p>遇到死锁，第一步就是阅读死锁日志。死锁日志通常分为两部分，上半部分说明了事务1在等待什么锁：</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-58ac01242a325207826630" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" touchscreen minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
170219 13:31:31
*** (1) TRANSACTION:
TRANSACTION 2A8BD, ACTIVE 11 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 2 lock struct(s), heap size 376, 1 row lock(s)
MySQL thread id 448218, OS thread handle 0x2abe5fb5d700, query id 18923238 renjun.fangcloud.net 121.41.41.92 root updating
delete from test where a = 2
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BD lock_mode X waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32
 0: len 4; hex 00000002; asc     ;;
 1: len 4; hex 00000002; asc     ;;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-58ac01242a325207826630-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a325207826630-2">2</div>
<div class="crayon-num" data-line="crayon-58ac01242a325207826630-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a325207826630-4">4</div>
<div class="crayon-num" data-line="crayon-58ac01242a325207826630-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a325207826630-6">6</div>
<div class="crayon-num" data-line="crayon-58ac01242a325207826630-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a325207826630-8">8</div>
<div class="crayon-num" data-line="crayon-58ac01242a325207826630-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a325207826630-10">10</div>
<div class="crayon-num" data-line="crayon-58ac01242a325207826630-11">11</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a325207826630-12">12</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-58ac01242a325207826630-1">
<span class="crayon-cn">170219</span><span class="crayon-h"> </span><span class="crayon-cn">13</span><span class="crayon-o">:</span><span class="crayon-cn">31</span><span class="crayon-o">:</span><span class="crayon-cn">31</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a325207826630-2">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">TRANSACTION</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a325207826630-3">
<span class="crayon-i">TRANSACTION</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BD</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">ACTIVE</span><span class="crayon-h"> </span><span class="crayon-cn">11</span><span class="crayon-h"> </span><span class="crayon-e">sec </span><span class="crayon-e">starting </span><span class="crayon-e">index </span><span class="crayon-e">read</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a325207826630-4">
<span class="crayon-e">mysql </span><span class="crayon-e">tables </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-st">use</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">locked</span><span class="crayon-h"> </span><span class="crayon-cn">1</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a325207826630-5">
<span class="crayon-e">LOCK </span><span class="crayon-i">WAIT</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-e">lock </span><span class="crayon-t">struct</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">size</span><span class="crayon-h"> </span><span class="crayon-cn">376</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-e">lock</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a325207826630-6">
<span class="crayon-e">MySQL </span><span class="crayon-e">thread </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">448218</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">OS </span><span class="crayon-e">thread </span><span class="crayon-i">handle</span><span class="crayon-h"> </span><span class="crayon-cn">0x2abe5fb5d700</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">query </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">18923238</span><span class="crayon-h"> </span><span class="crayon-v">renjun</span><span class="crayon-sy">.</span><span class="crayon-v">fangcloud</span><span class="crayon-sy">.</span><span class="crayon-i">net</span><span class="crayon-h"> </span><span class="crayon-cn">121.41.41.92</span><span class="crayon-h"> </span><span class="crayon-e">root </span><span class="crayon-e">updating</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a325207826630-7">
<span class="crayon-e">delete </span><span class="crayon-e">from </span><span class="crayon-e">test </span><span class="crayon-i">where</span><span class="crayon-h"> </span><span class="crayon-v">a</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a325207826630-8">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">WAITING </span><span class="crayon-st">FOR</span><span class="crayon-h"> </span><span class="crayon-r">THIS</span><span class="crayon-h"> </span><span class="crayon-e">LOCK </span><span class="crayon-st">TO</span><span class="crayon-h"> </span><span class="crayon-e">BE </span><span class="crayon-v">GRANTED</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a325207826630-9">
<span class="crayon-e">RECORD </span><span class="crayon-e">LOCKS </span><span class="crayon-e">space </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">page </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">923</span><span class="crayon-h"> </span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">80</span><span class="crayon-h"> </span><span class="crayon-i">index</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">of </span><span class="crayon-i">table</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">oauthdemo</span><span class="crayon-sy">`</span><span class="crayon-sy">.</span><span class="crayon-sy">`</span><span class="crayon-v">test</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">trx </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BD</span><span class="crayon-h"> </span><span class="crayon-v">lock</span><span class="crayon-sy">_</span>mode<span class="crayon-h"> </span><span class="crayon-i">X</span><span class="crayon-h"> </span><span class="crayon-e">waiting</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a325207826630-10">
<span class="crayon-e">Record </span><span class="crayon-v">lock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">PHYSICAL </span><span class="crayon-v">RECORD</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">_</span>fields<span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">compact </span><span class="crayon-v">format</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">info </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">32</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a325207826630-11">
<span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a325207826630-12">
<span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0048 seconds] -->
<p>从日志里我们可以看到事务1当前正在执行<code>delete from test where a = 2</code>，该条语句正在申请索引a的X锁，所以提示<code>lock_mode X waiting</code>。</p>
<p>然后日志的下半部分说明了事务2当前持有的锁以及等待的锁：</p>
<!-- Crayon Syntax Highlighter v2.7.1.1 -->

		<div id="crayon-58ac01242a329702890750" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" touchscreen minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;">
<div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div>
<div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div>
</div>
</div>
			<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;">
*** (2) TRANSACTION:
TRANSACTION 2A8BC, ACTIVE 18 sec inserting
mysql tables in use 1, locked 1
4 lock struct(s), heap size 1248, 3 row lock(s), undo log entries 2
MySQL thread id 448217, OS thread handle 0x2abe5fd65700, query id 18923239 renjun.fangcloud.net 121.41.41.92 root update
insert into test (id,a) values (10,2)
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BC lock_mode X locks rec but not gap
Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32
 0: len 4; hex 00000002; asc     ;;
 1: len 4; hex 00000002; asc     ;;
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BC lock mode S waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32
 0: len 4; hex 00000002; asc     ;;
 1: len 4; hex 00000002; asc     ;;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-num" data-line="crayon-58ac01242a329702890750-1">1</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a329702890750-2">2</div>
<div class="crayon-num" data-line="crayon-58ac01242a329702890750-3">3</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a329702890750-4">4</div>
<div class="crayon-num" data-line="crayon-58ac01242a329702890750-5">5</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a329702890750-6">6</div>
<div class="crayon-num" data-line="crayon-58ac01242a329702890750-7">7</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a329702890750-8">8</div>
<div class="crayon-num" data-line="crayon-58ac01242a329702890750-9">9</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a329702890750-10">10</div>
<div class="crayon-num" data-line="crayon-58ac01242a329702890750-11">11</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a329702890750-12">12</div>
<div class="crayon-num" data-line="crayon-58ac01242a329702890750-13">13</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a329702890750-14">14</div>
<div class="crayon-num" data-line="crayon-58ac01242a329702890750-15">15</div>
<div class="crayon-num crayon-striped-num" data-line="crayon-58ac01242a329702890750-16">16</div>
</div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;">
<div class="crayon-line" id="crayon-58ac01242a329702890750-1">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">TRANSACTION</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a329702890750-2">
<span class="crayon-i">TRANSACTION</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BC</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">ACTIVE</span><span class="crayon-h"> </span><span class="crayon-cn">18</span><span class="crayon-h"> </span><span class="crayon-e">sec </span><span class="crayon-e">inserting</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a329702890750-3">
<span class="crayon-e">mysql </span><span class="crayon-e">tables </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-st">use</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">locked</span><span class="crayon-h"> </span><span class="crayon-cn">1</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a329702890750-4">
<span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-e">lock </span><span class="crayon-t">struct</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">size</span><span class="crayon-h"> </span><span class="crayon-cn">1248</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">row </span><span class="crayon-e">lock</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">undo </span><span class="crayon-e">log </span><span class="crayon-i">entries</span><span class="crayon-h"> </span><span class="crayon-cn">2</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a329702890750-5">
<span class="crayon-e">MySQL </span><span class="crayon-e">thread </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">448217</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">OS </span><span class="crayon-e">thread </span><span class="crayon-i">handle</span><span class="crayon-h"> </span><span class="crayon-cn">0x2abe5fd65700</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">query </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">18923239</span><span class="crayon-h"> </span><span class="crayon-v">renjun</span><span class="crayon-sy">.</span><span class="crayon-v">fangcloud</span><span class="crayon-sy">.</span><span class="crayon-i">net</span><span class="crayon-h"> </span><span class="crayon-cn">121.41.41.92</span><span class="crayon-h"> </span><span class="crayon-e">root </span><span class="crayon-e">update</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a329702890750-6">
<span class="crayon-e">insert </span><span class="crayon-e">into </span><span class="crayon-e">test</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">id</span><span class="crayon-sy">,</span><span class="crayon-v">a</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">values</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">,</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a329702890750-7">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">HOLDS </span><span class="crayon-e">THE </span><span class="crayon-e">LOCK</span><span class="crayon-sy">(</span><span class="crayon-v">S</span><span class="crayon-sy">)</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a329702890750-8">
<span class="crayon-e">RECORD </span><span class="crayon-e">LOCKS </span><span class="crayon-e">space </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">page </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">923</span><span class="crayon-h"> </span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">80</span><span class="crayon-h"> </span><span class="crayon-i">index</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">of </span><span class="crayon-i">table</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">oauthdemo</span><span class="crayon-sy">`</span><span class="crayon-sy">.</span><span class="crayon-sy">`</span><span class="crayon-v">test</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">trx </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BC</span><span class="crayon-h"> </span><span class="crayon-v">lock</span><span class="crayon-sy">_</span>mode<span class="crayon-h"> </span><span class="crayon-i">X</span><span class="crayon-h"> </span><span class="crayon-e">locks </span><span class="crayon-e">rec </span><span class="crayon-e">but </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">gap</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a329702890750-9">
<span class="crayon-e">Record </span><span class="crayon-v">lock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">PHYSICAL </span><span class="crayon-v">RECORD</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">_</span>fields<span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">compact </span><span class="crayon-v">format</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">info </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">32</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a329702890750-10">
<span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a329702890750-11">
<span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a329702890750-12">
<span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">WAITING </span><span class="crayon-st">FOR</span><span class="crayon-h"> </span><span class="crayon-r">THIS</span><span class="crayon-h"> </span><span class="crayon-e">LOCK </span><span class="crayon-st">TO</span><span class="crayon-h"> </span><span class="crayon-e">BE </span><span class="crayon-v">GRANTED</span><span class="crayon-o">:</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a329702890750-13">
<span class="crayon-e">RECORD </span><span class="crayon-e">LOCKS </span><span class="crayon-e">space </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">page </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">923</span><span class="crayon-h"> </span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">80</span><span class="crayon-h"> </span><span class="crayon-i">index</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">a</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">of </span><span class="crayon-i">table</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-v">oauthdemo</span><span class="crayon-sy">`</span><span class="crayon-sy">.</span><span class="crayon-sy">`</span><span class="crayon-v">test</span><span class="crayon-sy">`</span><span class="crayon-h"> </span><span class="crayon-e">trx </span><span class="crayon-i">id</span><span class="crayon-h"> </span><span class="crayon-cn">2A8BC</span><span class="crayon-h"> </span><span class="crayon-e">lock </span><span class="crayon-i">mode</span><span class="crayon-h"> </span><span class="crayon-i">S</span><span class="crayon-h"> </span><span class="crayon-e">waiting</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a329702890750-14">
<span class="crayon-e">Record </span><span class="crayon-v">lock</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">heap </span><span class="crayon-i">no</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-e">PHYSICAL </span><span class="crayon-v">RECORD</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">_</span>fields<span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">compact </span><span class="crayon-v">format</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">info </span><span class="crayon-i">bits</span><span class="crayon-h"> </span><span class="crayon-cn">32</span>
</div>
<div class="crayon-line" id="crayon-58ac01242a329702890750-15">
<span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
<div class="crayon-line crayon-striped-line" id="crayon-58ac01242a329702890750-16">
<span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">len</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">hex</span><span class="crayon-h"> </span><span class="crayon-cn">00000002</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">asc</span><span class="crayon-h">     </span><span class="crayon-sy">;</span><span class="crayon-sy">;</span>
</div>
</div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0070 seconds] -->
<p>从日志的<code>HOLDS THE LOCKS(S)</code>块中我们可以看到事务2持有索引a的X锁，并且是记录锁（Record Lock）。该锁是通过事务2在步骤2执行的delete语句申请的。由于是RR隔离模式下的基于唯一索引的等值查询（Where a = 2），所以会申请一个记录锁，而非next-key锁。</p>
<p>从日志的<code>WAITING FOR THIS LOCK TO BE GRANTED</code>块中我们可以看到事务2正在申请S锁，也就是共享锁。该锁是<code>insert into test (id,a) values (10,2)</code>语句申请的。<strong>insert语句在普通情况下是会申请排他锁，也就是X锁，但是这里出现了S锁。这是因为a字段是一个唯一索引，所以insert语句会在插入前进行一次duplicate key的检查，为了使这次检查成功，需要申请S锁防止其他事务对a字段进行修改。</strong></p>
<p>那么为什么该S锁会失败呢？这是<strong>对同一个字段的锁的申请是需要排队的</strong>。S锁前面还有一个未申请成功的X锁，所以S锁必须等待，所以形成了循环等待，死锁出现了。</p>
<p>通过阅读死锁日志，我们可以清楚地知道两个事务形成了怎样的循环等待，再加以分析，就可以逆向推断出循环等待的成因，也就是死锁形成的原因。</p>
<h3 id="死锁形成流程图">死锁形成流程图</h3>
<p>为了让大家更好地理解死锁形成的原因，我们再通过表格的形式阐述死锁形成的流程：</p>
<table>
<thead>
<tr>
<th>步骤</th>
<th>事务1</th>
<th>事务2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
<td>begin</td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>delete from test where a = 2; 执行成功，事务2占有a=2下的X锁，类型为记录锁。</td>
</tr>
<tr>
<td>3</td>
<td>begin</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>delete from test where a = 2; 事务1希望申请a=2下的X锁，但是由于事务2已经申请了一把X锁，两把X锁互斥，所以X锁申请进入锁请求队列。</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>出现死锁，事务1权重较小，所以被选择回滚（成为牺牲品）。</td>
<td>insert into test (id, a) values (10, 2); 由于a字段建立了唯一索引，所以需要申请S锁以便检查duplicate key，由于插入的a的值还是2，所以排在X锁后面。但是前面的X锁的申请只有在事务2commit或者rollback之后才能成功，此时形成了循环等待，死锁产生。</td>
</tr>
</tbody>
</table>
<h2 id="拓展">拓展</h2>
<p>在排查死锁的过程中，有个同事还发现了上述场景会产生另一种死锁，该场景无法通过手工复现，只有高并发场景下才有可能复现。</p>
<p>该死锁对应的日志这里就不贴出了，与上一个死锁的核心差别是事务2等待的锁从S锁换成了X锁，也就是<code>lock_mode X locks gap before rec insert intention waiting</code>。我们还是通过表格来详细说明该死锁产生的流程：</p>
<table>
<thead>
<tr>
<th>步骤</th>
<th>事务1</th>
<th>事务2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
<td>begin</td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>delete from test where a = 2; 执行成功，事务2占有a=2下的X锁，类型为记录锁。</td>
</tr>
<tr>
<td>3</td>
<td>begin</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>【insert第1阶段】insert into test (id, a) values (10, 2); 事务2申请S锁进行duplicate key进行检查。检查成功。</td>
</tr>
<tr>
<td>5</td>
<td>delete from test where a = 2; 事务1希望申请a=2下的X锁，但是由于事务2已经申请了一把X锁，两把X锁互斥，所以X锁申请进入锁请求队列。</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>出现死锁，事务1权重较小，所以被选择回滚（成为牺牲品）。</td>
<td>【insert第2阶段】insert into test (id, a) values (10, 2); 事务2开始插入数据，S锁升级为X锁，类型为insert intention。同理，X锁进入队列排队，形成循环等待，死锁产生。</td>
</tr>
</tbody>
</table>
<h2 id="总结">总结</h2>
<p>排查死锁时，首先需要根据死锁日志分析循环等待的场景，然后根据当前各个事务执行的SQL分析出加锁类型以及顺序，逆向推断出如何形成循环等待，这样就能找到死锁产生的原因了。</p>
<p>PS：<strong>上述分析都是基于经验的推断，希望其他小伙伴们能够指出当中的错误以及不足指出，谢谢！</strong></p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="http://hedengcheng.com/?p=844" target="_blank" rel="external">【强推】一个最不可思议的Mysql死锁分析</a></li>
<li><a href="http://hedengcheng.com/?p=771" target="_blank" rel="external">【强推】Mysql加锁处理分析</a></li>
<li><a href="http://mysqllover.com/?p=411" target="_blank" rel="external">Innodb锁系统之如何阅读死锁日志</a></li>
<li><a href="http://mysqllover.com/?p=431" target="_blank" rel="external">源码分析insert和delete操作的加锁</a></li>
<li><a href="https://yq.aliyun.com/articles/40995" target="_blank" rel="external">Innodb锁相关源码翻译</a></li>
</ul>

        
        
        
    




        <!-- BEGIN #author-bio -->


<!-- END #author-bio -->
	
{% endraw %}
