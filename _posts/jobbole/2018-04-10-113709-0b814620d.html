---
layout: post
title: '创建订单实现幂等的一点思考'
time: 2018-04-10 00:00:00 +0800
site_name: jobbole.com
source_url: http://blog.jobbole.com/113709/
---
{% raw %}


        			<div class="textwidget"></div>
		
		<div>
<h3 id="幂等的概念">幂等的概念</h3>
<p>大部分文章都会说，同一个操作，进行多次操作后，结果是一样的，就可以说这个操作是支持幂等的。感觉不太准确，比如一个http get操作，可能每次的结果都不一样，但是其实是幂等的。看了很多文章，感觉下面的定义比较准确：</p>
<blockquote></blockquote>
<h3 id="创建订单的幂等">创建订单的幂等</h3>
<p>如果一个用户分两次下单，购买的商品都是一样的。</p>
<p>第一次请求：user1：购买一个商品product1；<br>
第二次请求：user1：还是购买一个商品product1；</p>
<p>这种场景也很常见，是需要生成两个订单的。这样子看起来貌似创建订单的接口做不了幂等，因为业务数据一样的情况下，还是需要生成多个订单。但是这样子设计还是有个坑，万一创建订单的接口超时了呢？并且调用方进行了重试的话，那就可能变成用户其实想下一个单，但是订单系统其实生成了多个订单。比如说：</p>
<blockquote></blockquote>
<p>如果订单接口不支持幂等的情况下，如何应付这种情况呢？有两种方法</p>
<p>第一种:</p>
<blockquote></blockquote>
<p>第二种：</p>
<blockquote></blockquote>
<p>上面两种方案都有人用过，但是都没实现幂等。其实针对上面的场景，用幂等来设计也不是很难。可以使用一个唯一的流水号ID，用来标识是不是同一个请求或者交易。这种ID通常都需要具备<code>全局唯一性</code>。假设让客户端来生成这个ID，每个创建订单的请求生成一个唯一的ID。那么订单系统如何根据来实现幂等呢？通常有两种。</p>
<p>第一种：</p>
<blockquote></blockquote>
<p>第二种：</p>
<blockquote></blockquote>
<p>不建议使用第二种方式，因为大部分情况下的请求都不是重试来的，让100%的请求都要去读取流水表，实在是不应该。另外，读取流水表的操作也是有潜在风险的，因为用数据库的读检查来确保数据存在性可能因为竞争而不生效，存在竞态条件。</p>
<p>建议用第一种方案，因为本来流水表就是要插入，顺便利用<code>UNIQUE KEY</code>的冲突特性来判断。</p>
<p>现在我们用第一种方案完整描述一下整个处理过程。</p>
<blockquote></blockquote>
<p>这里又有一个坑，万一调用方进行重试的时候，重新生成一个流水号，那就没得救了，会生成多个订单了。这个只能让客户端来保证了。</p>
<h3 id="关于多重幂等">关于多重幂等</h3>
<p>假设创建订单的接口在创建订单的时候，还需要依赖一些外部系统，如果订单创建接口实现了幂等，但是外部接口没有实现幂等的话，还是可能出现<code>幂等漏洞</code>。属于整个链路幂等的问题了。好复杂。目前还没想好如何处理这种情况呢。</p>
<h3 id="思考题">思考题</h3>

</div>

        
            

    

    
        
    




        <!-- BEGIN #author-bio -->



<!-- END #author-bio -->
	
{% endraw %}
