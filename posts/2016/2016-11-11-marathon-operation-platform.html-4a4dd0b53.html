<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mesos 实战-3：Marathon 作为运维管理平台 | IT技术干货</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="IT技术干货 KernelHacks 最好的技术站点 技术信息 纯干货">
    <link rel="canonical" href="http://iftti.com/posts/2016/2016-11-11-marathon-operation-platform.html-4a4dd0b53.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">IT技术干货</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Mesos 实战-3：Marathon 作为运维管理平台</h1>
    <p class="meta"><span class="time">Nov 11, 2016</span><span class="source_url"> • 来自 liulantao.com <a name="liulantao.com" href="http://blog.liulantao.com/marathon-operation-platform.html" target="_blank">[原文链接]</a></span></p>
  </header>

  <article class="post-content">
  

          <p>Marathon 是运行在 Mesos 之上的应用管理平台、运维平台。
本文将学习 Marathon 的基本概念、部署管理和使用方法。</p>

<p>前文中我们已通过<a href="/mesos.html">Mesos 实战-1：Mesos 起步</a>部署一套 Mesos 集群，通过<a href="/mesos-frameworks.html">Mesos 实战-2：Mesos 框架初探</a>了解 Mesos 框架的基本结构。
在框架的基础上，Marathon 平台的出现使得往 Mesos 上部署应用更加便捷。</p>

<!--excerpt-->

<p>本文主要学习内容有：</p>

<ul>
  <li>Marathon 安装
    <ul>
      <li>Marathon UI</li>
    </ul>
  </li>
  <li>Marathon API
    <ul>
      <li>创建一个 Demo，运行 dstat</li>
    </ul>
  </li>
  <li>运维部署流程讨论</li>
</ul>

<h3 id="why-marathon">Why Marathon?</h3>

<p>我们知道了 Mesos 平台能提供资源调度的功能。</p>

<p>但是具体采用什么样的策略调度，优先级怎么区分，异常情况如何处理，都需要在 <code class="highlighter-rouge">Mesos 框架</code>中实现。
实际生产中使用的计算任务，调度需求类型相对比较固定，每个业务需求去都实现一个框架的负担会比较重。
因此需要有一套通用的平来实现这些基本调度需求，又可以大大降低开发和运维工作量。</p>

<p><strong><em>Marathon</em></strong> 就是这样一套通用型的应用管理框架／平台。</p>

<h4 id="section">特性</h4>

<ul>
  <li>高可用，支持多主节点（主备模式）自动切换</li>
  <li>支持多种容器环境</li>
  <li>支持有状态服务，如数据库</li>
  <li>使用 Web 管理界面用于配置操作和监控系统状态</li>
  <li>约束规则，比如限制任务分布在特定节点</li>
  <li>服务发现、负载均衡</li>
  <li>支持健康检查，实现容错</li>
  <li>支持事件订阅，用于集成到其它系统</li>
  <li>运行指标监控接口</li>
  <li>完善易用的 REST API</li>
</ul>

<h3 id="marathon">安装 Marathon</h3>

<p>使用 Mesosphere 的软件仓库安装是比较简单的选择。</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>yum install -y http://repos.mesosphere.com/el-testing/7/noarch/RPMS/mesosphere-el-repo-7-3.noarch.rpm &amp;&amp; \
yum update -y &amp;&amp; \
yum install -y marathon

# 启动
systemctl start marathon
</code></pre>
</div>

<p>还可以下载安装包手动安装。
（本文写作时版本为 1.1.1）</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>$ curl -O http://downloads.mesosphere.com/marathon/v1.1.1/marathon-1.1.1.tgz
$ tar xzf marathon-1.1.1.tgz

# 启动
$ ./bin/start --master zk://127.0.0.1:2181/mesos --zk zk://127.0.0.1:2181/marathon
</code></pre>
</div>

<h4 id="marathon-ui-">Marathon UI 介绍</h4>

<p>默认情况下，Marathon 在 8080 端口上启动了 web 管理界面。</p>

<p>Marathon UI 展示了应用的状态。</p>

<p><img src="/images/liulantao.com/4867aa20eef3877a045e188681075f88.jpg" alt="Marathon UI"></p>

<h3 id="section-1">创建应用</h3>

<p>从最基本的任务开始，创建一个简单的应用，执行 <code class="highlighter-rouge">dstat</code> 命令。</p>

<h4 id="section-2">应用定义文件</h4>

<p>首先，准备应用定义文件。
此文件为 JSON 格式，定义了应用的名称（id）、命令、资源（cpu、内存等）和实例数量等信息。</p>

<p>先来看下这个文件等内容：</p>

<div class="highlighter-rouge">
<pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dstat-demo"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"cmd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dstat -tapm"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"cpus"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w">
  </span><span class="nt">"mem"</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w">
  </span><span class="nt">"instances"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>注意，
其中的 <code class="highlighter-rouge">cmd</code> 字段包含了应用将要执行的命令行。
进程的数量 <code class="highlighter-rouge">instances</code> 为 2。</p>

<h4 id="marathon-ui--1">通过 Marathon UI 创建应用</h4>

<p>在 Web 页面上，点击创建（’Create Application’）按钮。
弹出操作窗中，切换为 JSON 模式（’JSON Mode’）。</p>

<p><img src="/images/liulantao.com/f1622b8ae1af7b98f2356c24c1f3fd31.jpg" alt="Create Application, JSON Mode"></p>

<p>将上一步准备的 JSON 内容复制的输入框内。
点击输入框旁的创建（’Create Application’）按钮，保存配置。
此时新建应用的信息，将出现在 Web 页面的应用列表。</p>

<h4 id="scale">伸缩（Scale）</h4>

<p>便捷的操作界面，是 Marathon 的一大优势。
让我们体验一下扩容操作，为刚创建的应用分配更多的计算资源。</p>

<p>应用列表中，点击应用最右侧的图标，下拉菜单选择 <code class="highlighter-rouge">Scale</code>。</p>

<p><img src="/images/liulantao.com/417c3e6a9724180040297c7b9810f7f9.jpg" alt="Scale Application 1"></p>

<p>修改应用实例数量，此时我们由 2 改为 4：</p>

<p><img src="/images/liulantao.com/1b4be9391a4e168ab2a1adb49ac9a88f.jpg" alt="Scale Application 2"></p>

<p>等待几秒钟，在应用列表中可以看到应用实例数量已经更新。
你可以随意修改数量，来体验伸缩的操作。</p>

<h4 id="marathon-api-createscale">使用 Marathon API 操作（create/scale）</h4>

<p>为了方便批量化管理，以上操作都可以通过 API 来实现。</p>

<p>API 文档可以参考 <a href="https://mesosphere.github.io/marathon/docs/generated/api.html">Marathon REST API documentation</a></p>

<p>我们使用其中的 <code class="highlighter-rouge">POST /v2/apps</code> 来创建应用，用 <code class="highlighter-rouge">PUT /v2/apps/{app_id}</code> 来对应用进行操作。
其中，<code class="highlighter-rouge">PUT /v2/apps/{app_id}</code> 也可以用来创建应用，仅限该 app_id 还不存在的情况下。</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>POST /v2/apps

Create and start a new application. Note: This operation will create a deployment. The operation finishes, if the deployment succeeds. You can query the deployments endoint to see the status of the deployment.


PUT /v2/apps/{app_id}

Replaces parameters of a running application. If no application with the given id exists, it will be created. If there is an application with this id, all running instances get upgraded to the new definition.

Note: This operation will create a deployment. The operation finishes, if the deployment succeeds. You can query the deployments endoint to see the status of the deployment.
</code></pre>
</div>

<h3 id="section-3">应用部署流程</h3>

<p>使用 Marathon 部署应用时，所有应用应尽量做到无状态（本地不保存数据），配置集中管理（本地不保存配置），支持随时迁移到其它节点（服务发现）。</p>

<p>一个比较理想的流程是：</p>

<ol>
  <li>创建应用／配置更新</li>
  <li>应用环境变量设置</li>
  <li>安装系统／应用环境依赖</li>
  <li>获取应用配置文件</li>
  <li>获取应用二进制文件</li>
  <li>启动应用进程，服务节点注册</li>
  <li>服务节点注销，下线应用进程</li>
</ol>

<p>这个流程中，有两个重要组件：CMDB 和 Service Registry。</p>

<p>其中，
CMDB 定义应用角色数据，如每个计算资源、进程属于哪组角色；Service Registry 保存服务状态，如每个服务有哪些进程。</p>

<p>关于 CMDB 和 Service Registry 的方案选型，是另一个较大的话题，以后做微服务方面分享时会涉及。</p>

<h3 id="next">Next</h3>

<p>作为运维平台，可用性也是重要的方面。
关于这个话题，Mesos／Marathon 可用性方面所做的工作，后面的文章将详细介绍。</p>

        


  </article>

  <div class="meta">
  
    <a class="basic-alignment left" href="/posts/2016/2016-10-12-mesos-frameworks.html-6be904e78.html" title="Previous Post: Mesos 实战-2：Mesos 框架初探" data-instant>&laquo; Mesos 实战-2：Mesos 框架初探</a>
  
  
    <a class="basic-alignment right" href="/posts/2016/2016-11-12-e8-87-aa-e7-84-b6-e8-af-ad-e8-a8-80-e5-a4-84-e7-90-86-e5-b7-a5-e5-85-b7-e5-8c-85spacy-e4-bb-8b-e7-bb-8d-408ddfd8f.html" title="Next Post: 自然语言处理工具包spaCy介绍" data-instant>自然语言处理工具包spaCy介绍 &raquo;</a>
  
</div>
  <div id="related">
  <h2 class="subheader">Related Posts <small>They might be useful</small></h2>
  <ul class="posts">
    
      <li><span>21 May 2018</span> &raquo; <a href="http://iftti.com/posts/2018/2018-05-21-114016-1b3612333.html">分布式之消息队列复习精讲</a></li>
    
      <li><span>20 May 2018</span> &raquo; <a href="http://iftti.com/posts/2018/2018-05-20-114009-9d318dfaa.html">分布式之延时任务方案解析</a></li>
    
      <li><span>19 May 2018</span> &raquo; <a href="http://iftti.com/posts/2018/2018-05-19-114012-06b67f2d6.html">分布式之缓存击穿</a></li>
    
  </ul>
</div>

  
<comments>

<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1936498"></script>
<!-- UY END -->

</comments>

</div>
      <!-- JiaThis Button BEGIN -->
<div class="jiathis_share_slide jiathis_share_24x24" id="jiathis_share_slide">
<div class="jiathis_share_slide_top" id="jiathis_share_title"></div>
<div class="jiathis_share_slide_inner">
<div class="jiathis_style_24x24">
<a class="jiathis_button_tsina"></a>
<a class="jiathis_button_googleplus"></a>
<a class="jiathis_button_twitter"></a>
<a class="jiathis_button_linkedin"></a>
<a class="jiathis_button_weixin"></a>
<a class="jiathis_button_cqq"></a>
<a class="jiathis_button_renren"></a>
<a class="jiathis_button_evernote"></a>
<a class="jiathis_button_pocket"></a>
<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'
	,slide:{
		divid:'wrap',
		pos:'left',
		gt:'true'
	}
};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1936498" charset="utf-8"></script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_slide.js" charset="utf-8"></script>
</div></div></div>
<!-- JiaThis Button END -->
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">IT技术干货</h2>

    <div class="footer-col-1 column">
      <p class="text">IT技术干货 KernelHacks 最好的技术站点 技术信息 纯干货</p>
      <ul>
        <li>汇集最好的科技与互联网信息</li>
        <li>Liu Lantao</li>
        <li><a href="mailto:iftti@iftti.com">iftti@iftti.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/Lax">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">Lax</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/liulantao">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">@liulantao</span>
          </a>
        </li>
        <li>
          <a href="https://plus.google.com/+LiuLantao">
            <span class="icon googleplus">
              <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                width="16px" height="16px" viewBox="0 0 134.658 131.646" enable-background="new 0 0 134.658 131.646"
                xml:space="preserve">
                <g>
                  <path fill="#C2C2C2" d="M126.515,4.109H8.144c-2.177,0-3.94,1.763-3.94,3.938v115.546c0,2.179,1.763,3.942,3.94,3.942h118.371
                  c2.177,0,3.94-1.764,3.94-3.942V8.048C130.455,5.872,128.691,4.109,126.515,4.109z"/>
                  <g>
                    <path fill="#FFFFFF" d="M70.479,71.845l-3.983-3.093c-1.213-1.006-2.872-2.334-2.872-4.765c0-2.441,1.659-3.993,3.099-5.43
                    c4.64-3.652,9.276-7.539,9.276-15.73c0-8.423-5.3-12.854-7.84-14.956h6.849l7.189-4.517H60.418
                    c-5.976,0-14.588,1.414-20.893,6.619c-4.752,4.1-7.07,9.753-7.07,14.842c0,8.639,6.633,17.396,18.346,17.396
                    c1.106,0,2.316-0.109,3.534-0.222c-0.547,1.331-1.1,2.439-1.1,4.32c0,3.431,1.763,5.535,3.317,7.528
                    c-4.977,0.342-14.268,0.893-21.117,5.103c-6.523,3.879-8.508,9.525-8.508,13.51c0,8.202,7.731,15.842,23.762,15.842
                    c19.01,0,29.074-10.519,29.074-20.932C79.764,79.709,75.344,75.943,70.479,71.845z M56,59.107
                    c-9.51,0-13.818-12.294-13.818-19.712c0-2.888,0.547-5.87,2.428-8.199c1.773-2.218,4.861-3.657,7.744-3.657
                    c9.168,0,13.923,12.404,13.923,20.382c0,1.996-0.22,5.533-2.762,8.09C61.737,57.785,58.762,59.107,56,59.107z M56.109,103.65
                    c-11.826,0-19.452-5.657-19.452-13.523c0-7.864,7.071-10.524,9.504-11.405c4.64-1.561,10.611-1.779,11.607-1.779
                    c1.105,0,1.658,0,2.538,0.111c8.407,5.983,12.056,8.965,12.056,14.629C72.362,98.542,66.723,103.65,56.109,103.65z"/>
                    <polygon fill="#FFFFFF" points="98.393,58.938 98.393,47.863 92.923,47.863 92.923,58.938 81.866,58.938 81.866,64.469
                    92.923,64.469 92.923,75.612 98.393,75.612 98.393,64.469 109.506,64.469 109.506,58.938"/>
                  </g>
                </g>
              </svg>
            </span>
            <span class="username">+LiuLantao</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      
<!--以下是QQ邮件列表订阅嵌入代码--><script >var nId = "6be92ef3590ee662cd5e6381ab2044c328716364f684cf3e",nWidth="auto",sColor="light",sText="填写您的邮件地址，订阅我们的精彩内容：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>

    </div>

  </div>

  <div class="wrap">
    <div>
      <a href="http://blog.liulantao.com">Blog</a> | <a href="http://1000bit.com">铅笔特评 1000bit</a> | <a href="http://visplanet.com">VisPlanet</a> | <a href="http://iftti.com">IT技术干货</a> | <a href="http://relax.org.cn">Relax</a> | <a href="http://hangzhou.io">杭州城市指南</a>
    </div>
  </div>

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1658815-7', 'iftti.com');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>


</footer>


    </body>
</html>